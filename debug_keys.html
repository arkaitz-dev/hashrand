<!DOCTYPE html>
<html>
<head>
    <title>Debug Ed25519 Keys - HashRand</title>
</head>
<body>
    <h1>ğŸ” Debug Ed25519 Keys Storage</h1>
    <button onclick="testKeyFlow()">Test Complete Key Flow</button>
    <div id="output"></div>

    <script>
        async function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += `<p>${message}</p>`;
            console.log(message);
        }

        async function testKeyFlow() {
            try {
                // Clear any existing IndexedDB data
                await log("ğŸ§¹ Clearing IndexedDB...");
                const dbs = await indexedDB.databases();
                for (const db of dbs) {
                    indexedDB.deleteDatabase(db.name);
                }
                await new Promise(resolve => setTimeout(resolve, 100));

                // Test 1: Check if session manager works
                await log("ğŸ“¦ Testing session manager...");

                // Import session manager
                const { sessionManager } = await import('./web/src/lib/session-manager.js');
                await log("âœ… Session manager imported");

                // Test server_pub_key storage
                const testKey = "abc123test456";
                await sessionManager.setServerPubKey(testKey);
                await log(`ğŸ’¾ Stored test server_pub_key: ${testKey}`);

                const retrievedKey = await sessionManager.getServerPubKey();
                await log(`ğŸ”„ Retrieved server_pub_key: ${retrievedKey}`);

                if (testKey === retrievedKey) {
                    await log("âœ… Server pub key storage/retrieval works!");
                } else {
                    await log("âŒ Server pub key storage/retrieval FAILED!");
                }

                // Test 2: Simulate magic link request
                await log("ğŸ”— Testing magic link request...");

                const testEmail = "debug@test.com";
                const response = await fetch('/api/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        payload: {
                            email: testEmail,
                            ui_host: "http://localhost:5173",
                            next: "/",
                            email_lang: "en",
                            pub_key: "debug_test_key_123"
                        },
                        signature: "debug_signature_123"
                    })
                });

                const responseData = await response.json();
                await log(`ğŸ“¨ Magic link response: ${JSON.stringify(responseData, null, 2)}`);

                if (responseData.payload && responseData.payload.server_pub_key) {
                    await log(`ğŸ”‘ Found server_pub_key in response: ${responseData.payload.server_pub_key}`);

                    // Store it
                    await sessionManager.setServerPubKey(responseData.payload.server_pub_key);
                    await log("ğŸ’¾ Stored server_pub_key from response");

                    // Verify it was stored
                    const storedKey = await sessionManager.getServerPubKey();
                    await log(`ğŸ” Verified stored key: ${storedKey}`);
                }

            } catch (error) {
                await log(`âŒ Error: ${error.message}`);
                console.error(error);
            }
        }
    </script>
</body>
</html>